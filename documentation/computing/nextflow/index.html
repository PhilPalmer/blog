<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academia 4.3.1"><meta name=generator content="Hugo 0.58.3"><meta name=author content="Phil Palmer"><meta name=description content="Nextflow is a workflow management system that allows you to build highly parallelizable &amp; scalable computational pipelines
Advatanges Advantages of using Nextflow (and workflow managers in general) is that they help make workflows more: - Portable - Thanks in part to it&rsquo;s built-in support of containers Nextflow pipelines can be run in a portable manner across different instructure be it Cloud, local or HPC - Reproducible - Thanks in part to it&rsquo;s built-in support of containers such as Docker &amp; Singularity - Scalable - Thanks in part to Nextflow&rsquo;s built-in parallelism as it&rsquo;s built on the data flow programming model"><link rel=alternate hreflang=en-us href=https://philpalmer.github.io/blog/documentation/computing/nextflow/><meta name=theme-color content=#5ca1fc><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.0/css/all.css integrity=sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans|Roboto+Mono&display=swap"><link rel=stylesheet href=/blog/css/academia.min.57046ce961b229bc82bb27159fabeb32.css><link rel=manifest href=/blog/site.webmanifest><link rel=icon type=image/png href=/blog/img/favicon.ico><link rel=apple-touch-icon type=image/png href=/blog/img/favicon.ico><link rel=canonical href=https://philpalmer.github.io/blog/documentation/computing/nextflow/><meta property=twitter:card content=summary><meta property=og:site_name content="Phil Palmer"><meta property=og:url content=https://philpalmer.github.io/blog/documentation/computing/nextflow/><meta property=og:title content="Nextflow | Phil Palmer"><meta property=og:description content="Nextflow is a workflow management system that allows you to build highly parallelizable &amp; scalable computational pipelines
Advatanges Advantages of using Nextflow (and workflow managers in general) is that they help make workflows more: - Portable - Thanks in part to it&rsquo;s built-in support of containers Nextflow pipelines can be run in a portable manner across different instructure be it Cloud, local or HPC - Reproducible - Thanks in part to it&rsquo;s built-in support of containers such as Docker &amp; Singularity - Scalable - Thanks in part to Nextflow&rsquo;s built-in parallelism as it&rsquo;s built on the data flow programming model"><meta property=og:image content=https://philpalmer.github.io/blog/img/icon-192.png><meta property=twitter:image content=https://philpalmer.github.io/blog/img/icon-192.png><meta property=og:locale content=en-us><meta property=article:published_time content=2019-05-05T00:00:00&#43;01:00><meta property=article:modified_time content=2019-05-05T00:00:00&#43;01:00><title>Nextflow | Phil Palmer</title></head><body id=top data-spy=scroll data-target=#TableOfContents data-offset=71><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id=navbar-main><div class=container><a class=navbar-brand href=/blog/>Phil Palmer</a>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar aria-controls=navbar aria-expanded=false aria-label="Toggle navigation"><span><i class="fas fa-bars"></i></span></button><div class="collapse navbar-collapse" id=navbar><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/blog/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/blog/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/blog/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/blog/#publications><span>Publications</span></a></li><li class=nav-item><a class="nav-link  active" href=/blog/documentation/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/#contact><span>Contact</span></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></div></nav><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 docs-sidebar"><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-3" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation">
<span><i class="fas fa-bars"></i></span></button></form><nav class="collapse docs-links" id=docs-nav><div class=docs-toc-item><a class=docs-toc-link href=/blog/documentation/computing/>Computing</a></div><div class=docs-toc-item><a class=docs-toc-link href=/blog/documentation/computing/conda/>Bioinformatics</a><ul class="nav docs-sidenav"><li><a href=/blog/documentation/computing/conda/>Conda</a></li><li class=active><a href=/blog/documentation/computing/nextflow/>Nextflow</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/blog/documentation/computing/machine-learning/>Data Science</a><ul class="nav docs-sidenav"><li><a href=/blog/documentation/computing/machine-learning/>Machine learning</a></li><li><a href=/blog/documentation/computing/python/>Python</a></li><li><a href=/blog/documentation/computing/r/>R</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/blog/documentation/computing/bash/>Tools</a><ul class="nav docs-sidenav"><li><a href=/blog/documentation/computing/bash/>Bash</a></li><li><a href=/blog/documentation/computing/docker/>Docker</a></li><li><a href=/blog/documentation/computing/git/>Git</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><a href=#advatanges>Advatanges</a></li><li><a href=#basics>Basics</a></li><li><a href=#patterns>Patterns</a><ul><li><a href=#inputs>Inputs</a><ul><li><a href=#split-text-input>Split text input</a></li><li><a href=#csv-input>CSV input</a></li><li><a href=#reusable-channels>Reusable channels</a></li><li><a href=#channel-duplication>Channel duplication</a></li><li><a href=#get-basename>Get basename</a></li><li><a href=#input-validation>Input validation</a></li></ul></li><li><a href=#processes>Processes</a><ul><li><a href=#conditional-input-files>Conditional input files</a></li><li><a href=#conditional-flags>Conditional flags</a></li><li><a href=#extra-flags>Extra flags</a></li><li><a href=#last-index-of>Last index of</a></li></ul></li><li><a href=#transforming-operators>Transforming operators</a><ul><li><a href=#reduce-channel>Reduce channel</a></li><li><a href=#complex-mapping>Complex mapping</a></li></ul></li><li><a href=#debugging>Debugging</a><ul><li><a href=#printing-channel>Printing channel</a></li><li><a href=#touch-files>Touch files</a></li></ul></li><li><a href=#output>Output</a><ul><li><a href=#publishdir>PublishDir</a></li></ul></li><li><a href=#groovy>Groovy</a><ul><li><a href=#helper-functions>Helper functions</a></li></ul></li><li><a href=#configuration>Configuration</a><ul><li><a href=#genomes-config>Genomes config</a></li><li><a href=#cloud-create>Cloud create</a></li></ul></li></ul></li><li><a href=#tips>Tips</a></li><li><a href=#useful-operators>Useful operators</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main><article class=article itemscope itemtype=http://schema.org/Article><div class=docs-article-container><h1 itemprop=name>Nextflow</h1><div class=article-style itemprop=articleBody><p><img src=../images/nextflow_logo.png alt=nextflow_logo></p><p><em>Nextflow is a workflow management system that allows you to build highly parallelizable &amp; scalable computational pipelines</em></p><h1 id=advatanges>Advatanges</h1><p>Advantages of using Nextflow (and workflow managers in general) is that they help make workflows more:
- Portable
- Thanks in part to it&rsquo;s built-in support of containers Nextflow pipelines can be run in a portable manner across different instructure be it Cloud, local or HPC
- Reproducible
- Thanks in part to it&rsquo;s built-in support of containers such as Docker &amp; Singularity
- Scalable
- Thanks in part to Nextflow&rsquo;s built-in parallelism as it&rsquo;s built on the data flow programming model</p><p>There are other workflow management systems such as <a href=https://snakemake.readthedocs.io/en/stable/ target=_blank>Snakemake</a>, <a href=https://www.commonwl.org/ target=_blank>CWL</a> and <a href=https://github.com/openwdl/wdl#getting-started-with-wdl target=_blank>WDL</a>, however, I am by far more familiar with <a href=https://www.nextflow.io/index.html target=_blank>Nextflow</a>. Some of the main advantages of each are that Nextflow benefits from lots of community support (see <a href=https://nf-co.re/ target=_blank>nf-core</a>), Snakemake is written in <a href=../python>Python</a> and CWL/WDL benefits from support from the <a href=https://www.broadinstitute.org/ target=_blank>Broad Institute</a>.</p><h1 id=basics>Basics</h1><p>The basic pipeline structure is as follows:
1) Pipeline (main script)
- Channels
- Processes
- Input
- Output
- Script
2) Configuration</p><p>See the <a href=https://www.nextflow.io/docs/latest/index.html target=_blank>Official documentation</a> &amp; <a href=https://github.com/lifebit-ai/jax-tutorial target=_blank>Nextflow tutorial</a></p><h1 id=patterns>Patterns</h1><p>You can find Nextflow scripts for each of the examples here: <a href=https://github.com/PhilPalmer/docs/tree/master/computing/nextflow-scripts target=_blank>https://github.com/PhilPalmer/docs/tree/master/computing/nextflow-scripts</a></p><p><em>Inspired by <a href=http://nextflow-io.github.io/patterns/index.html target=_blank>Nextflow patterns</a></em></p><h2 id=inputs>Inputs</h2><h3 id=split-text-input>Split text input</h3><p>Create a channel from a plain text file split line by line</p><pre><code>Channel
  .fromPath(params.regions)
  .ifEmpty { exit 1, &quot;Cannot find file : ${params.regions}&quot; }
  .splitText()
  .map { it -&gt; it.trim() }
  .set { regions }
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run split_text_input.nf
</code></pre><h3 id=csv-input>CSV input</h3><p>Create a channel from a CSV file input</p><pre><code>Channel
  .fromPath(params.vcf_paths)
  .ifEmpty { exit 1, &quot;Cannot find CSV file : ${params.vcf_paths}&quot; }
  .splitCsv(skip:1)
  .map { sample_id,vcf,index -&gt; [sample_id,file(vcf),file(index)] }
  .set { vcfs }
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run csv_input.nf
</code></pre><h3 id=reusable-channels>Reusable channels</h3><p>Nextflow consumes (queue) channels meaning that they are consumed on use. However, it is possible to prevent needing to duplicate channels by creating value channels instead like so!</p><pre><code>inputChannel = Channel.value(file(params.input_path))

// Channel can be used multiple times
inputChannel.println()
inputChannel.println()
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run reusable_channels.nf
</code></pre><h3 id=channel-duplication>Channel duplication</h3><p>Sometimes you may need to duplicate a channel. This is espeically true if it&rsquo;s a channel which contains multiple values (and/or is a queue channel) because these are consumed by Nextflow on use</p><pre><code>Channel
  .fromPath(params.input_path)
  .ifEmpty { exit 1, &quot;${params.input_path} not found&quot;}
  .into { inputChannel; inputChannel1; inputChannel2 }
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run channel_duplication.nf
</code></pre><h3 id=get-basename>Get basename</h3><p>Get the basename (i.e. the name filename minus the file extension) of a file in a channel. <em>You can also use <code>simpleName</code> to get everything prior to the first period (<code>.</code>)</em></p><pre><code>Channel
  .fromPath(params.input_path)
  .map { file -&gt; [file.baseName, file] }
  .ifEmpty { exit 1, &quot;${params.input_path} not found&quot;}
  .set { inputChannel }
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run get_basename.nf
</code></pre><h3 id=input-validation>Input validation</h3><pre><code>if (!params.important_parameter) exit 1, &quot;The params `--important_parameter` has not been set.\n\tPlease provide a valid value for this parameter&quot;
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run input_validation.nf
</code></pre><hr><h2 id=processes>Processes</h2><h3 id=conditional-input-files>Conditional input files</h3><p>Nextflow does not like having conditional input files for processes. Fortunately you can use optional input files like so</p><pre><code>optional_input_path = params.optional_input_path ? params.optional_input_path : 'data/no_file.txt'

Channel
  .fromPath(optional_input_path)
  .ifEmpty { exit 1, &quot;${optional_input_path} not found&quot;}
  .set { optionalInputChannel }

process test {

  echo true

  input:
  file(optional_input) from optionalInputChannel

  script:
  optional_flag = optional_input != 'no_file.txt' ? &quot;--optional_input $optional_input&quot; : ''
  &quot;&quot;&quot;
  some_command.sh $optional_flag
  &quot;&quot;&quot;
}
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run optional_input.nf
</code></pre><h3 id=conditional-flags>Conditional flags</h3><p>Here the <code>optional_flag</code> will only be present if the user has set the <code>optional_flag</code> Nextflow parameter</p><pre><code>process test {

  echo true

  script:
  optional_flag = params.optional_flag ? &quot;--optional_flag $params.optional_flag&quot; : ''
  &quot;&quot;&quot;
  some_command.sh $optional_flag
  &quot;&quot;&quot;
}
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow run optional_input.nf
</code></pre><h3 id=extra-flags>Extra flags</h3><h3 id=last-index-of>Last index of</h3><hr><h2 id=transforming-operators>Transforming operators</h2><h3 id=reduce-channel>Reduce channel</h3><p><a href=https://github.com/lifebit-ai/genetic-traits/blob/master/main.nf#L157 target=_blank>https://github.com/lifebit-ai/genetic-traits/blob/master/main.nf#L157</a></p><h3 id=complex-mapping>Complex mapping</h3><hr><h2 id=debugging>Debugging</h2><h3 id=printing-channel>Printing channel</h3><h3 id=touch-files>Touch files</h3><hr><h2 id=output>Output</h2><h3 id=publishdir>PublishDir</h3><p><a href=https://github.com/lifebit-ai/genetic-traits/blob/master/main.nf#L204-L210 target=_blank>https://github.com/lifebit-ai/genetic-traits/blob/master/main.nf#L204-L210</a></p><hr><h2 id=groovy>Groovy</h2><h3 id=helper-functions>Helper functions</h3><pre><code>// define helper functions
def isMode(mode) {
  params.mode.toLowerCase().contains(mode)
}
def isTsv() {
  params.reads.endsWith('tsv')
}
def get_pairs_simplename(simplename) {
  simplename = simplename.endsWith('_1') ? simplename.substring(0, simplename.length() - 2) : simplename
  simplename = simplename.endsWith('_R1') ? simplename.substring(0, simplename.length() - 3) : simplename
  return simplename
}
</code></pre><hr><h2 id=configuration>Configuration</h2><h3 id=genomes-config>Genomes config</h3><h3 id=cloud-create>Cloud create</h3><p>You can use Nextflow to launch an AWS instance (in this case one to run <a href=https://aws.amazon.com/marketplace/pp/Illumina-Inc-DRAGEN-Complete-Suite/B07CZ3F5HY target=_blank>Dragen</a>)</p><p><code>cloud-spot.config</code>:</p><pre><code>aws {
  accessKey = ''
  secretKey = ''
  region = 'eu-west-1'
}
cloud {
  imageId = 'ami-0ba4b94467989e99a'
  instanceType = 'f1.4xlarge'
  userName = 'centos'
  keyName = 'dragen'
  bootStorageSize = '100 GB'
}
</code></pre><p>Run it:</p><pre><code class=language-bash>nextflow -c cloud-spot.config cloud create cluster_name -c 1
</code></pre><h1 id=tips>Tips</h1><ul><li><code>nextflow console</code></li><li><code>log.info</code></li></ul><h1 id=useful-operators>Useful operators</h1><p><code>groupTuple()</code></p><p><code>combine()</code> (by)</p><p><code>map()</code>
Swiss army knife
Re-order or reduce channels (although Nextflow also provides a <code>reduce</code> function)</p><p><code>set()</code></p><p><code>into()</code></p><p><code>.set()</code></p><p><a href=https://www.nextflow.io/docs/latest/operator.html#collect target=_blank><code>collect()</code></a></p><p><code>splitCsv()</code></p><p><code>merge()</code></p><p><code>flatten()</code></p><p><code>choice()</code></p></div><div class=article-widget><div class=post-nav><div class=post-nav-item><div class=meta-nav>Previous</div><a href=/blog/documentation/computing/git/ rel=next>Git</a></div><div class=post-nav-item><div class=meta-nav>Next</div><a href=/blog/documentation/computing/python/ rel=prev>Python</a></div></div></div></div><div class=body-footer>Last updated on May 5, 2019</div></article><footer class=site-footer><div class=container><div class=row><div class=col-md-6><p>Powered by
<a href=https://themefisher.com target=_blank rel=noopener>themefisher</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.</p></div><div class=col-md-6><ul class="list-inline network-icon text-right"><li class=list-inline-item><a href=https://twitter.com/phil_palmer_ target=_blank rel=noopener title="DM Me"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=list-inline-item><a href=https://linkedin.com/in/phil-palmer target=_blank rel=noopener title="DM Me"><i class="fab fa-linkedin" aria-hidden=true></i></a></li></ul></div></div></div></footer></main></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin=anonymous></script><script>anchors.add();</script><script src=/blog/js/academia.min.7276a6a3624de715a5c7f54c7c07696d.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&times;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>